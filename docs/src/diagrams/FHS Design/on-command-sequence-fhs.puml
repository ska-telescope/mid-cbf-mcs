@startuml
'https://plantuml.com/sequence-diagram
skinparam backgroundColor #EEEBDC
skinparam sequence {
ParticipantBorderColor DodgerBlue
ParticipantBackgroundColor DeepSkyBlue
ActorBorderColor DarkGreen
ActorBackgroundColor Green
BoxBorderColor LightBlue
BoxBackgroundColor #F0FFFF
}
skinparam collections {
  BackGroundColor LightBlue
  BorderColor DodgerBlue
}
skinparam database {
  BackgroundColor LightGreen
  BorderColor DarkGreen
}
title FHS On Command Sequence\n
box "\nMCS\n"
  participant "Mid.CBF\nController" as controller
  participant "Terabox\n" as fhs_tel
end box
participant "Local\nCache" as cache #Salmon
participant "k8s\n" as k8s #Orange
participant "FHS\nBMC" as fhs_bmc #Grey
participant "FPGA\nBMC" as fpga_bmc #Grey
box "\nFHS\n"
participant "NIC\n" as nic #LightGreen
participant "kubelet\n" as klet #Thistle
box "Worker Node"
participant "FHS\nController" as fhs_safety
participant "FHS\nCPU" as fhs_cpu
collections "FHS\nFPGA" as fhs_fpga
end box
end box

note over controller, fhs_tel   : AdminMode: ONLINE\nOpState: DISABLE

group #LightCyan For each FHS in configuration:
  controller    ->  fhs_tel       : On()
  
  fhs_tel       ->  fhs_bmc       : TurnServerOn()
  fhs_tel       ->  nic           : ping()
  nic           --> fhs_tel       : result
  k8s            ->  cache        : Download\nBitstreams
  k8s            ->  klet         : Init()
  klet           ->  fhs_safety   : Deploy()
  klet           ->  fhs_cpu      : Deploy()
  klet           ->  fhs_fpga     : Deploy()
  note over fhs_safety, fhs_fpga  : AdminMode: OFFLINE\nOpState: DISABLE
  fhs_fpga      ->  fhs_fpga      : Mount k8s\nvolume
  fhs_tel       ->  fhs_safety    : AdminMode.ONLINE
  fhs_tel       ->  fhs_cpu       : AdminMode.ONLINE
  fhs_tel       ->  fhs_fpga      : AdminMode.ONLINE
  fhs_fpga      ->  fpga_bmc      : LoadBitstreams()
  fpga_bmc      --> fhs_fpga      : result
  note over fhs_safety, fhs_fpga  : AdminMode: ONLINE\nOpState: ON
  note over fhs_tel               : OpState: ON
  fhs_tel       -->  controller   : result
end group

note over controller            : OpState: ON

@enduml