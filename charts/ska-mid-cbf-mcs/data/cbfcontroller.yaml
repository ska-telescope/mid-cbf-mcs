name: cbfcontroller
function: cbf-central-control
domain: csp-monitoring
command: "CbfController"
instances: ["controller"]
depends_on:
  - device: sys/database/2
livenessProbe:
{{ toYaml $.Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml $.Values.readinessProbe | indent 2 }}
image:
{{- with $.Values.midcbf.image}}
  registry: {{ quote .registry }}
  image: {{ quote .image }}
  tag: {{ quote .tag }}
  pullPolicy: {{ quote .pullPolicy }}
{{- end }}
server:
  name: "CbfController"
  instances:
  - name: "controller"
    classes:
    - name: "CbfController"
      devices:
      - name: {{ $.Values.controller_trl }}
        properties:
          - name: "MaxCapabilities"
            values:
            - {{ printf "VCC:%d" $.Values.num_vcc }}
            - {{ printf "FSP:%d" $.Values.num_fsp }}
            - {{ printf "Subarray:%d" $.Values.num_subarray }}
          - name: "CbfSubarray"
            values:
            {{- $num_subarray := (add1 $.Values.num_subarray | int) }}
            {{- range untilStep 1 $num_subarray 1 }}
            {{- $subarray_id := .}}
            - {{ printf "%s/%02d" $.Values.subarray_trl . }}
            {{- end }}
          - name: "FSP"
            values:
            {{- $num_fsp := (add1 $.Values.num_fsp | int) }}
            {{- range untilStep 1 $num_fsp 1 }}
            - {{ printf "%s/%02d" $.Values.fsp_trl . }}
            {{- end }}
          - name: "VCC"
            values:
            {{- $num_vcc := (add1 $.Values.num_vcc | int) }}
            {{- range untilStep 1 $num_vcc 1 }}
            - {{ printf "%s/%02d" $.Values.vcc_trl . }}
            {{- end }}
          - name: "TalonLRU"
            values:
            {{- $num_vcc := (div $.Values.num_vcc 2 | add1 | int) }}
            {{- range untilStep 1 $num_vcc 1 }}
            - {{ printf "mid-cbf/talon-lru/%02d" . }} # TODO: remove for AA2
            {{- end }}
          - name: "TalonBoard"
            values:
            {{- $num_vcc := (add1 $.Values.num_vcc | int) }}
            {{- range untilStep 1 $num_vcc 1 }}
            - {{ printf "mid-cbf/talon-board/%02d" . }} # TODO: remove for AA2
            {{- end }}
          - name: "PowerSwitch"  # TODO: remove for AA2
            values:
            - "mid_csp_cbf/power_switch/001"
            - "mid_csp_cbf/power_switch/002"
            - "mid_csp_cbf/power_switch/003"
            - "mid_csp_cbf/power_switch/004"
          - name: "FsSLIM"
            values:
            - "mid_csp_cbf/slim/slim-fs"  # TODO: remove for AA2
          - name: "VisSLIM"
            values:
            - "mid_csp_cbf/slim/slim-vis"  # TODO: remove for AA2
          - name: "LRCTimeout"
            values:
            - {{ quote $.Values.controllerTimeout }}
          - name: "TalonDxConfigPath"
            values:
            - "mnt/talondx-config"
          - name: "HWConfigPath"
            values:
            - "mnt/hw_config/hw_config.yaml"
          - name: "FsSLIMConfigPath"
            values:
            - "mnt/slim/fs/slim_config.yaml"
          - name: "VisSLIMConfigPath"
            values:
            - "mnt/slim/vis/slim_config.yaml"

environment_variables:
- name: NAMESPACE
  value: "{{ .Release.Namespace }}"
- name: ENVIRONMENT
  value: "{{ .Values.hostInfo.environment }}"
- name: MINIKUBE_HOST_IP
  value: "{{ .Values.hostInfo.hostIP }}"
- name: EXTERNAL_DB_PORT
  value: "{{ .Values.hostInfo.externalPort }}"
- name: CLUSTER_DOMAIN
  value: "{{ .Values.hostInfo.clusterDomain }}"
volume:
  existingClaimName: "artifacts-pvc-{{ .Release.Name }}"
  mountPath: "/app/mnt/talondx-config"
  readOnly: false

{{- if or (.Values.hw_config) (.Values.fs_slim) (.Values.vis_slim) (.Values.talondx_config) }}
extraVolumes:
{{- if .Values.hw_config }}
- name: hw-config-mount
  configMap: 
    name:  hwconfig-configmap
{{- end }}
{{- if .Values.talondx_config }}
- name: talondx-config-mount
  configMap: 
    name:  talondx-config-configmap
{{- end }}
{{- if .Values.fs_slim }}
- name: fs-slim-mount
  configMap:
    name:  fs-slim-configmap
{{- end }}
{{- if .Values.vis_slim }}
- name: vis-slim-mount
  configMap:
    name:  vis-slim-configmap
{{- end }}
extraVolumeMounts:
{{- if .Values.hw_config }}
  - name: hw-config-mount
    mountPath: /app/mnt/hw_config
{{- end }}
{{- if .Values.talondx_config }}
  - name: talondx-config-mount
    mountPath: /app/mnt/talondx_config
{{- end }}
{{- if .Values.fs_slim }}
  - name: fs-slim-mount
    mountPath: /app/mnt/slim/fs
{{- end }}
{{- if .Values.vis_slim }}
  - name: vis-slim-mount
    mountPath: /app/mnt/slim/vis
{{- end }}
{{- end }}