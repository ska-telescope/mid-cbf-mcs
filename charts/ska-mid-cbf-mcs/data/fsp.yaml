name: fsp
function: fsp-processing
domain: signal-processing
command: "FspMulti"
instances: ["fsp"]
depends_on:
  - device: sys/database/2
livenessProbe:
{{ toYaml $.Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml $.Values.readinessProbe | indent 2 }}
image:
{{- with $.Values.midcbf.image}}
  registry: {{ .registry | quote}}
  image: {{ .image | quote}}
  tag: {{ .tag | quote}}
  pullPolicy: {{ .pullPolicy | quote}}
{{- end }}
server:
  name: "FspMulti"
  instances:
  - name: "fsp"
    classes:
    - name: "Fsp"
      devices:
      {{- $num_fsp := (add1 $.Values.num_fsp | int) }}
      {{- range untilStep 1 $num_fsp 1 }}
      {{- $fsp_id := .}}
      - name: {{ printf "%s/%02d" $.Values.fsp_trl . }}
        properties:
          - name: "DeviceID"
            values:
            - {{ quote $fsp_id }}
          - name: "FspCorrSubarray"
            values:
            {{- $num_subarray := (add1 $.Values.num_subarray | int) }}
            {{- range untilStep 1 $num_subarray 1 }}
            - {{ printf "%s/%02d.%02d" $.Values.fsp_corr_trl $fsp_id .}}
            {{- end }}
          - name: "FspPstSubarray"
            values:
            {{- $num_subarray := (add1 $.Values.num_subarray | int) }}
            {{- range untilStep 1 $num_subarray 1 }}
            - {{ printf "%s/%02d.%02d" $.Values.fsp_pst_trl $fsp_id .}}
            {{- end }}
          - name: "HpsFspControllerAddress"
            values:
            - "talondx-001/fsp-app/fsp-controller" # TODO
      {{- end }}

    - name: "FspCorrSubarray"
      devices:
      {{- $num_fsp := (add1 $.Values.num_fsp | int) }}
      {{- range untilStep 1 $num_fsp 1 }}
      {{- $fsp_id := .}}
      {{- $num_subarray := (add1 $.Values.num_subarray | int) }}
      {{- range untilStep 1 $num_subarray 1 }}
      {{- $subarray_id := .}}
      - name: {{ printf "%s/%02d.%02d" $.Values.fsp_corr_trl $fsp_id $subarray_id}}
        properties:
          - name: "HpsFspCorrControllerAddress"
            values:
            - "talondx-001/fsp-app/fsp-corr-controller" # TODO
          - name: "LRCTimeout"
            values:
            - {{ quote $.Values.fspTimeout }}
      {{- end }}
      {{- end }}
    
    - name: "FspPstSubarray"
      devices:
      {{- $num_fsp := (add1 $.Values.num_fsp | int) }}
      {{- range untilStep 1 $num_fsp 1 }}
      {{- $fsp_id := .}}
      {{- $num_subarray := (add1 $.Values.num_subarray | int) }}
      {{- range untilStep 1 $num_subarray 1 }}
      {{- $subarray_id := .}}
      - name: {{ printf "%s/%02d.%02d" $.Values.fsp_pst_trl $fsp_id $subarray_id}}
        properties:
          - name: "HpsFspPstControllerAddress"
            values:
            - "talondx-001/fsp-app/fsp-pst-controller" # TODO
          - name: "LRCTimeout"
            values:
            - {{ quote $.Values.fspTimeout }}
      {{- end }}
      {{- end }}