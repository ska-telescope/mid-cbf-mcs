name: cbfsubarray
function: cbf-subarray-observation
domain: subarray
command: "CbfSubarray"
instances: ["cbfsubarray"]
depends_on:
  - device: sys/database/2
livenessProbe:
{{ toYaml $.Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml $.Values.readinessProbe | indent 2 }}
image:
{{- with $.Values.midcbf.image}}
  registry: {{ quote .registry }}
  image: {{ quote .image }}
  tag: {{ quote .tag }}
  pullPolicy: {{ quote .pullPolicy }}
{{- end }}
server:
  name: "CbfSubarray"
  instances:
  - name: "cbfsubarray"
    classes:
    - name: "CbfSubarray"
      devices:
      {{- $num_subarray := (add1 $.Values.num_subarray | int) }}
      {{- range untilStep 1 $num_subarray 1 }}
      {{- $subarray_id := .}}
      - name: {{ printf "%s/%02d" $.Values.subarray_trl . }}
        properties:
          - name: "DeviceID"
            values:
            - {{ quote $subarray_id }}
          - name: "CbfControllerAddress"
            values:
            - {{ $.Values.controller_trl }}
          - name: "FSP"
            values:
            {{- $num_fsp := (add1 $.Values.num_fsp | int) }}
            {{- range untilStep 1 $num_fsp 1 }}
            - {{ printf "%s/%02d" $.Values.fsp_trl . }}
            {{- end }}
          - name: "FspCorrSubarray"
            values:
            {{- $num_fsp := (add1 $.Values.num_fsp | int) }}
            {{- range untilStep 1 $num_fsp 1 }}
            - {{ printf "%s/%02d.%02d" $.Values.fsp_corr_trl . $subarray_id}}
            {{- end }}
          - name: "FspPstSubarray"
            values:
            {{- $num_fsp := (add1 $.Values.num_fsp | int) }}
            {{- range untilStep 1 $num_fsp 1 }}
            - {{ printf "%s/%02d.%02d" $.Values.fsp_pst_trl . $subarray_id}}
            {{- end }}
          - name: "VCC"
            values:
            {{- $num_vcc := (add1 $.Values.num_vcc | int) }}
            {{- range untilStep 1 $num_vcc 1 }}
            - {{ printf "%s/%02d" $.Values.vcc_trl . }}
            {{- end }}
          - name: "TalonBoard"
            values:
            {{- $num_vcc := (add1 $.Values.num_vcc | int) }}
            {{- range untilStep 1 $num_vcc 1 }}
            - {{ printf "mid_csp_cbf/talon_board/%02d" . }} # TODO: remove for AA2
            {{- end }}
          - name: "VisSLIM"
            values:
            - "mid_csp_cbf/slim/slim-vis" # TODO: remove for AA2
      {{- end}}
